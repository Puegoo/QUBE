{% extends 'master.html' %}
{% load static %}
{% block content %}
<div class="form-container" style="max-width: 700px;">
  <h2>Edycja zadania</h2>
  
  {% if messages %}
  <div class="messages">
    {% for message in messages %}
    <div class="message {% if message.tags %}{{ message.tags }}{% endif %}" style="color: {% if message.tags == 'error' %}red{% elif message.tags == 'success' %}green{% else %}blue{% endif %}; margin-bottom: 15px; text-align: center;">
      {{ message }}
    </div>
    {% endfor %}
  </div>
  {% endif %}
  
  <form method="POST">
    {% csrf_token %}
    
    <label>Nazwa zadania</label>
    <input type="text" name="title" value="{{ task.title }}" required {% if not is_leader %}disabled{% endif %}>
    
    <label>Opis</label>
    <textarea name="description" required>{{ task.description }}</textarea>
    
    <label>Priorytet</label>
    <select name="priority" {% if not is_leader %}disabled{% endif %}>
      <option value="low" {% if task.priority == "low" %}selected{% endif %}>Niski</option>
      <option value="medium" {% if task.priority == "medium" %}selected{% endif %}>Średni</option>
      <option value="high" {% if task.priority == "high" %}selected{% endif %}>Wysoki</option>
    </select>
    
    <label>Status</label>
    <select name="status">
      <option value="Oczekujące" {% if task.get_status_display == "Oczekujące" %}selected{% endif %}>Oczekujące</option>
      <option value="W trakcie" {% if task.get_status_display == "W trakcie" %}selected{% endif %}>W trakcie</option>
      <option value="Zakończone" {% if task.get_status_display == "Zakończone" %}selected{% endif %}>Zakończone</option>
    </select>
    
    <label>Data oddania</label>
    <input type="date" name="due_date" value="{% if task.due_date %}{{ task.due_date }}{% endif %}" {% if not is_leader %}disabled{% endif %}>
    
    <label>Przydziel do</label>
    <select name="assigned_user" {% if not is_leader %}disabled{% endif %}>
      {% for member in group_members %}
        <option value="{{ member.username }}" {% if assigned_user and assigned_user.username == member.username %}selected{% endif %}>
          {{ member.username }}
        </option>
      {% endfor %}
    </select>
    
    {% if is_leader %}
    <label>Zależne od zadań</label>
    <div class="dependency-container">
      <select name="dependencies" multiple style="height: 100px;">
        {% for dep_task in all_tasks %}
          {% if dep_task.uid != task.uid %}
            <option value="{{ dep_task.uid }}" 
              {% for dependency in dependent_tasks %}
                {% if dependency.uid == dep_task.uid %}selected{% endif %}
              {% endfor %}>
              {{ dep_task.title }}
            </option>
          {% endif %}
        {% endfor %}
      </select>
      <p class="helptext">Przytrzymaj Ctrl aby wybrać wiele zadań</p>
    </div>
    {% endif %}
    
    <button type="submit" class="btn">Zapisz</button>
  </form>
</div>

<script>
  // JavaScript do sprawdzania cykli zależności
  document.addEventListener('DOMContentLoaded', function() {
    const dependencySelect = document.querySelector('select[name="dependencies"]');
    if (dependencySelect) {
      dependencySelect.addEventListener('change', function(e) {
        const selectedOptions = Array.from(this.selectedOptions).map(option => option.value);
        const taskUid = '{{ task.uid }}';
        
        // Sprawdzanie każdej nowo wybranej opcji
        selectedOptions.forEach(depUid => {
          fetch('/api/check-dependency/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
              task_uid: taskUid,
              dependency_uid: depUid
            })
          })
          .then(response => response.json())
          .then(data => {
            if (data.cycleDetected) {
              alert(data.message);
              // Odznaczamy opcję powodującą cykl
              for (let i = 0; i < this.options.length; i++) {
                if (this.options[i].value === depUid) {
                  this.options[i].selected = false;
                  break;
                }
              }
            }
          });
        });
      });
    }
    
    // Funkcja pomocnicza do pobierania tokena CSRF
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  });
</script>
{% endblock %}