{% extends 'master.html' %}
{% load static %}
{% load dict_extras %}

{% block content %}
<div class="group-detail-container">

  <!-- LEWA KOLUMNA – Zadania -->
  <div class="group-detail-left">
    {% if is_leader %}
      <h3>Zadania w grupie</h3>
    {% else %}
      <h3>Twoje zadania</h3>
    {% endif %}
    <div class="task-filters">
      <p>Filtr: [dzień / priorytet / status...]</p>
    </div>

    <ul class="task-list">
      <!-- Lider widzi wszystkie zadania, członek widzi tylko swoje -->
      {% if is_leader %}
        {% for task in all_tasks %}
          <li>
            <strong>{{ task.title }}</strong> – {{ task.status }}
            <!-- Link-ikona (ołówek) do edycji zadania -->
            <a href="#" class="icon-link" title="Edytuj zadanie" onclick="editTask('{{ task.uid }}')">✏️</a>
          </li>
        {% empty %}
          <li>Brak zadań w grupie.</li>
        {% endfor %}
      {% else %}
        {% for task in user_tasks %}
          <li>
            <strong>{{ task.title }}</strong> – {{ task.status }}
            <!-- Członek może np. zmienić status zadania -->
            <a href="#" class="icon-link" title="Zmień status zadania" onclick="editTaskStatus('{{ task.uid }}')">✏️</a>
          </li>
        {% empty %}
          <li>Nie masz przypisanych zadań.</li>
        {% endfor %}
      {% endif %}
    </ul>

    {% if is_leader %}
      <button class="btn add-task-btn" onclick="openAddTaskModal()">Dodaj zadanie</button>
    {% endif %}
  </div>

  <!-- ŚRODKOWA KOLUMNA – Lista członków i przypisane do nich zadania -->
  <div class="group-detail-middle">
    <h3>Lista członków i ich zadania</h3>
    <ul class="member-tasks-list">
      {% for member in group_members %}
        <li>
          <strong>{{ member.username }}</strong>
          <ul>
            {% if member.username in member_tasks %}
              {% for task in member_tasks|dict_key:member.username %}
                <li>{{ task.title }} – {{ task.status }}</li>
              {% empty %}
                <li>Brak zadań</li>
              {% endfor %}
            {% else %}
              <li>Brak zadań</li>
            {% endif %}
          </ul>
        </li>
      {% endfor %}
    </ul>
  </div>

  <!-- PRAWA KOLUMNA – Członkowie grupy (z rolami) -->
  <div class="group-detail-right">
    <h3>Członkowie grupy</h3>
    <ul class="member-list">
      {% for member in group_members %}
        <li>
          <span>{{ member.username }}</span>
          {% if member.username in member_roles %}
            <!-- Wyświetlanie roli -->
            &emsp; {{ member_roles|dict_key:member.username }} &emsp;
          {% endif %}
          {% if is_leader %}
            <!-- Ikonka do edycji członka -->
            <a href="#" class="icon-link" title="Modyfikuj członka" onclick="editMember('{{ member.username }}')">✏️</a>
          {% endif %}
        </li>
      {% endfor %}
    </ul>

    {% if is_leader %}
      <button class="btn add-member-btn" onclick="openAddMemberModal()">Dodaj członka</button>
    {% endif %}
  </div>
</div>

<!-- Modal dodawania zadania -->
<div id="addTaskModal" class="modal">
  <div class="modal-content form-container"> 
    <h4>Dodaj zadanie</h4>
    <form method="POST" action="{% url 'add_task' group.uid %}">
      {% csrf_token %}
      
      <label>Nazwa zadania</label>
      <input type="text" name="title" required>

      <label>Komu przydzielasz?</label>
      <select name="assigned_user">
        {% for member in group_members %}
          <option value="{{ member.username }}">{{ member.username }}</option>
        {% endfor %}
      </select>

      <label>Status</label>
      <select name="status">
        <option value="pending">pending</option>
        <option value="in-progress">in-progress</option>
        <option value="done">done</option>
      </select>

      <label>Priorytet</label>
      <select name="priority">
        <option value="low">Niski</option>
        <option value="medium">Średni</option>
        <option value="high">Wysoki</option>
      </select>

      <label>Opis</label>
      <textarea name="description"></textarea>

      <div class="modal-footer">
        <button type="submit">Zapisz</button>
        <button type="button" class="cancel-btn" onclick="closeAddTaskModal()">Anuluj</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal dodawania członka -->
<div id="addMemberModal" class="modal">
  <div class="modal-content form-container">
    <h4>Dodaj członka</h4>
    <form method="POST" action="{% url 'add_member' group.uid %}">
      {% csrf_token %}

      <label>Wybierz użytkownika</label>
      <select name="new_member_username">
        {% for user in available_users %}
          <option value="{{ user.username }}">{{ user.username }}</option>
        {% endfor %}
      </select>

      <label>Rola</label>
      <input type="text" name="new_member_role">

      <div class="modal-footer">
        <button type="submit">Dodaj</button>
        <button type="button" class="cancel-btn" onclick="closeAddMemberModal()">Anuluj</button>
      </div>
    </form>
  </div>
</div>

<!-- Wczytanie skryptu JS na końcu, aby elementy HTML były już załadowane -->
<script src="{% static 'js/script.js' %}"></script>
{% endblock %}