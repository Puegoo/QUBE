{% extends 'master.html' %}
{% load static %}
{% load dict_extras %}
{% load arithmetic %}

<script>
  var currentGroupUid = "{{ group.uid }}";
</script>

{% block content %}

<!-- Nagłówek grupy -->
<div class="group-header">
  <div class="group-header-left">
    <h2 id="groupNameDisplay">{{ group.name }}</h2>
    {% if is_leader %}
    <button id="editGroupNameButton" onclick="openEditGroupNameModal()" title="Edytuj nazwę grupy" style="background:none; border:none; cursor:pointer;">
      <img src="{% static 'icons/edit.svg' %}" alt="Edytuj" style="height:20px; width:auto;">
    </button>
    {% endif %}
  </div>
  {% if is_leader %}
    <div class="group-header-right">
      <button type="button" class="filter-btn" onclick="openAddTaskModal()" title="Dodaj zadanie">
        <img src="{% static 'icons/add_task.svg' %}" alt="Dodaj zadanie" class="filter-icon">
      </button>
      <button type="button" class="filter-btn" onclick="openAddMemberModal()" title="Dodaj członka">
        <img src="{% static 'icons/add_member.svg' %}" alt="Dodaj członka" class="filter-icon">
      </button>
    </div>
  {% endif %}
</div>

<div class="group-detail-container">
  <!-- LEWA KOLUMNA – Zadania -->
  <div class="group-detail-left">
    {% if is_leader %}
      <h3>Zadania w grupie</h3>
    {% else %}
      <h3>Twoje zadania</h3>
    {% endif %}
    <div class="filter-buttons">
      <button type="button" class="filter-btn" data-filter="due_date" onclick="setTaskFilter('due_date')">
        <img src="{% static 'icons/data.svg' %}" alt="Data" class="filter-icon">
      </button>
      <button type="button" class="filter-btn" data-filter="status" onclick="setTaskFilter('status')">
        <img src="{% static 'icons/status.svg' %}" alt="Status" class="filter-icon">
      </button>
      <button type="button" class="filter-btn" data-filter="priority" onclick="setTaskFilter('priority')">
        <img src="{% static 'icons/priority.svg' %}" alt="Priorytet" class="filter-icon">
      </button>
      <button type="button" class="sort-btn" onclick="toggleTaskSortOrder()">
        <img src="{% static 'icons/ascending.svg' %}" alt="Sortuj rosnąco" class="sort-icon" id="taskSortIcon">
      </button>
    </div>
    <ul class="task-list">
      {% if is_leader %}
        {% for task in all_tasks %}
          <li data-due_date="{{ task.due_date|default_if_none:'' }}" data-status="{{ task.status }}" data-priority="{{ task.priority }}">
            <div class="task-tile" style="width: 100%;">
              <div class="task-tile-left" style="justify-content: flex-start;">
                <span>{{ task.title }}</span>
              </div>
              <div class="task-tile-center">
                {{ task.status }}
              </div>
              <div class="task-tile-right" style="justify-content: flex-end;">
                <a href="{% url 'edit_task' group.uid task.uid %}" class="icon-link" title="Edytuj zadanie">
                  <img src="{% static 'icons/edit.svg' %}" alt="Edytuj" style="height:20px; width:auto;">
                </a>
              </div>
            </div>
          </li>
        {% empty %}
          <li>Brak zadań w grupie.</li>
        {% endfor %}
      {% else %}
        {% for task in user_tasks %}
          <li data-due_date="{{ task.due_date|default_if_none:'' }}" data-status="{{ task.status }}" data-priority="{{ task.priority }}">
            <div class="task-tile" style="width: 100%;">
              <div class="task-tile-left" style="justify-content: flex-start;">
                <span>{{ task.title }}</span>
              </div>
              <div class="task-tile-center">
                {{ task.status }}
              </div>
              <div class="task-tile-right" style="justify-content: flex-end;">
                <a href="{% url 'edit_task' group.uid task.uid %}" class="icon-link" title="Zmień status zadania">
                  <img src="{% static 'icons/edit.svg' %}" alt="Edytuj" style="height:20px; width:auto;">
                </a>
              </div>
            </div>
          </li>
        {% empty %}
          <li>Nie masz przypisanych zadań.</li>
        {% endfor %}
      {% endif %}
    </ul>
    <!-- Usunięto przycisk "Dodaj zadanie" z lewej kolumny -->
  </div>

  <!-- ŚRODKOWA KOLUMNA – Lista członków i ich zadania (kafelki) -->
  <div class="group-detail-middle">
    <h3>Lista członków i ich zadania</h3>
    <ul class="member-tasks-list">
      {% for member in group_members %}
        <li>
          <strong>{{ member.username }}</strong>
          <ul style="list-style: none; margin: 0; padding: 0;">
            {% if member.username in member_tasks %}
              {% for task in member_tasks|dict_key:member.username %}
                <li style="border: none; margin: 0; padding: 0;">
                  <div class="task-tile" style="width: 100%;">
                    <div class="task-tile-left">
                      <span class="priority-icon" style="color: {{ task.priority|priority_color }};">
                        {{ task.priority|priority_symbol }}
                      </span>
                      &nbsp; {{ task.title }}
                    </div>
                    <div class="task-tile-center">
                      {{ task.status }}
                    </div>
                    <div class="task-tile-right">
                      {% if task.due_date %}
                        {% if task.days_left != None %}
                          {% if task.days_left >= 0 %}
                            Za {{ task.days_left }} dni
                          {% else %}
                            Po terminie
                          {% endif %}
                        {% else %}
                          brak terminu
                        {% endif %}
                      {% else %}
                        brak terminu
                      {% endif %}
                    </div>
                  </div>
                </li>
              {% empty %}
                <li>Brak zadań</li>
              {% endfor %}
            {% else %}
              <li>Brak zadań</li>
            {% endif %}
          </ul>
        </li>
      {% endfor %}
    </ul>
  </div>

<!-- PRAWA KOLUMNA – Członkowie grupy (z rolami) -->
<div class="group-detail-right">
  <h3>Członkowie grupy</h3>
  <ul class="member-list">
    <!-- Lider - wyświetlony na samej górze -->
    <li class="leader-item">
      <div class="member-tile leader-tile">
        <div class="member-tile-left">{{ leader.username }}</div>
        <div class="member-tile-center">Lider</div>
        <div class="member-tile-right">
          <!-- Brak przycisku edycji dla lidera -->
        </div>
      </div>
    </li>
    <!-- Oddzielenie lidera od reszty -->
    <hr class="leader-separator">
    <!-- Pozostali członkowie -->
    {% for member in group_members %}
      {% if member.username != leader.username %}
        <li>
          <div class="member-tile">
            <div class="member-tile-left">
              {{ member.username }}
            </div>
            <div class="member-tile-center">
              {% if member.username in member_roles %}
                {{ member_roles|dict_key:member.username }}
              {% else %}
                Brak roli
              {% endif %}
            </div>
            <div class="member-tile-right">
              {% if is_leader %}
                <a href="{% url 'edit_member' group.uid member.username %}" class="icon-link" title="Modyfikuj członka">
                  <img src="{% static 'icons/edit.svg' %}" alt="Edytuj" style="height:20px; width:auto;">
                </a>
              {% endif %}
            </div>
          </div>
        </li>
      {% endif %}
    {% endfor %}
  </ul>
  <!-- Przycisk "Dodaj członka" może pozostać poza listą lub być usunięty -->
</div>

<!-- Modal dodawania zadania -->
<div id="addTaskModal" class="modal">
  <div class="modal-content form-container">
    <h4>Dodaj zadanie</h4>
    <form method="POST" action="{% url 'add_task' group.uid %}">
      {% csrf_token %}
      <label>Nazwa zadania</label>
      <input type="text" name="title" required>
      
      <label>Priorytet</label>
      <select name="priority">
        <option value="low">Niski</option>
        <option value="medium">Średni</option>
        <option value="high">Wysoki</option>
      </select>
      
      <label>Data oddania</label>
      <input type="date" name="due_date">
      
      <label>Komu przydzielasz?</label>
      <select name="assigned_user">
        {% for member in group_members %}
          <option value="{{ member.username }}">{{ member.username }}</option>
        {% endfor %}
      </select>
      
      <label>Status</label>
      <select name="status">
        <option value="pending">pending</option>
        <option value="in-progress">in-progress</option>
        <option value="done">done</option>
      </select>
      
      <label>Opis</label>
      <textarea name="description"></textarea>
      
      <div class="modal-footer">
        <button type="submit">Zapisz</button>
        <button type="button" class="cancel-btn" onclick="closeAddTaskModal()">Anuluj</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal dodawania członka -->
<div id="addMemberModal" class="modal">
  <div class="modal-content form-container">
    <h4>Dodaj członka</h4>
    <form method="POST" action="{% url 'add_member' group.uid %}">
      {% csrf_token %}
      <label>Wybierz użytkownika</label>
      <select name="new_member_username">
        {% for user in available_users %}
          <option value="{{ user.username }}">{{ user.username }}</option>
        {% endfor %}
      </select>
      
      <label>Rola</label>
      <input type="text" name="new_member_role">
      
      <div class="modal-footer">
        <button type="submit">Dodaj</button>
        <button type="button" class="cancel-btn" onclick="closeAddMemberModal()">Anuluj</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal edycji nazwy grupy -->
<div id="editGroupNameModal" class="modal">
  <div class="modal-content form-container">
    <h4>Edycja nazwy grupy</h4>
    <input type="text" id="modalGroupNameInput" class="modal-input" placeholder="Wpisz nową nazwę grupy">
    <div class="modal-footer">
      <button type="button" class="btn" onclick="saveGroupNameModal()">Zapisz</button>
      <button type="button" class="btn cancel-btn" onclick="closeEditGroupNameModal()">Anuluj</button>
    </div>
  </div>
</div>

<script src="{% static 'js/script.js' %}"></script>
{% endblock %}