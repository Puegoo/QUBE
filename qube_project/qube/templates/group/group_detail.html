{% extends 'master.html' %}
{% load static %}
{% load dict_extras %}

{% block content %}
<div class="group-detail-container">
  
  <!-- LEWA KOLUMNA – Zadania (filtry, priorytety, etc.) -->
  <div class="group-detail-left">
    <h3>Zadania w grupie</h3>
    <div class="task-filters">
      <p>Filtr: [dzień / priorytet / status...]</p>
    </div>
    <ul class="task-list">
      {% for task in all_tasks %}
        <li>
          <strong>{{ task.title }}</strong> – {{ task.status }}
          <!-- Ewentualny priorytet / data końca -->
          {% if is_leader %}
            <button>Edytuj</button>
          {% endif %}
        </li>
      {% empty %}
        <li>Brak zadań w grupie.</li>
      {% endfor %}
    </ul>

    {% if is_leader %}
      <button class="btn add-task-btn" onclick="openAddTaskModal()">Dodaj zadanie</button>
    {% endif %}
  </div>
  
  <!-- ŚRODKOWA KOLUMNA – Lista członków + przypisane do nich zadania -->
  <div class="group-detail-middle">
    <h3>Lista członków i ich zadania</h3>
    <ul class="member-tasks-list">
      {% for member in group_members %}
        <li>
          <strong>{{ member.username }}</strong>
          <ul>
            {% if member.username in member_tasks %}
              {% for task in member_tasks|dict_key:member.username %}
                <li>{{ task.title }} – {{ task.status }}</li>
              {% empty %}
                <li>Brak zadań</li>
              {% endfor %}
            {% else %}
              <li>Brak zadań</li>
            {% endif %}
          </ul>
        </li>
      {% endfor %}
    </ul>
  </div>
  
  <!-- PRAWA KOLUMNA – Lista członków z możliwością dodania/edycji (tylko lider) -->
  <div class="group-detail-right">
    <h3>Członkowie grupy</h3>
    <ul class="member-list">
      {% for member in group_members %}
        <li>
          {{ member.username }}
          {% if is_leader %}
            <!-- Modyfikacja roli/usunięcie? -->
            <button onclick="editMember('{{ member.username }}')">Modyfikuj</button>
          {% endif %}
        </li>
      {% endfor %}
    </ul>

    {% if is_leader %}
      <button class="btn add-member-btn" onclick="openAddMemberModal()">Dodaj członka</button>
    {% endif %}
  </div>
</div>

<!-- Modal dodawania zadania -->
<div id="addTaskModal" class="modal" style="display: none;">
  <div class="modal-content">
    <h4>Dodaj zadanie</h4>
    <form method="POST" action="{% url 'add_task' group.uid %}">
      {% csrf_token %}
      <label>Nazwa zadania</label>
      <input type="text" name="title">
      
      <label>Komu przydzielasz?</label>
      <select name="assigned_user">
        {% for member in group_members %}
          <option value="{{ member.username }}">{{ member.username }}</option>
        {% endfor %}
      </select>
      
      <label>Status</label>
      <select name="status">
        <option value="pending">pending</option>
        <option value="in-progress">in-progress</option>
        <option value="done">done</option>
      </select>
      
      <label>Priorytet</label>
      <select name="priority">
        <option value="low">Niski</option>
        <option value="medium">Średni</option>
        <option value="high">Wysoki</option>
      </select>

      <label>Opis</label>
      <textarea name="description"></textarea>
      
      <button type="submit">Zapisz</button>
      <button type="button" onclick="closeAddTaskModal()">Anuluj</button>
    </form>
  </div>
</div>

<!-- Modal dodawania członka -->
<div id="addMemberModal" class="modal" style="display: none;">
  <div class="modal-content">
    <h4>Dodaj członka</h4>
    <form method="POST" action="{% url 'add_member' group.uid %}">
      {% csrf_token %}
      <label>Username</label>
      <input type="text" name="new_member_username">
      
      <label>Rola</label>
      <input type="text" name="new_member_role">
      
      <button type="submit">Dodaj</button>
      <button type="button" onclick="closeAddMemberModal()">Anuluj</button>
    </form>
  </div>
</div>
{% endblock %}
